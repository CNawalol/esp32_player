/*
#include <Arduino.h>
#include "U8g2lib.h"
#include "lyricparser/Line.h"

U8G2_SH1106_128X64_NONAME_F_4W_HW_SPI u8g2(U8G2_R0, */
/* cs=*//*
 5, */
/* dc=*//*
 4, */
/* reset=*//*
 22);

string qrc = R"(
[446,2345]阴(446,310)天(756,291)快(1047,318)乐(1365,180) - (1545,180)陈(1726,376)奕(2102,331)迅(2433,358)
[2791,1205]词(2791,310)：(3101,0)易(3101,258)家(3359,353)扬(3712,284)
[3996,13134]曲(3996,281)：(4277,0)林(4277,455)俊(4732,425)杰(5157,11973)
[17130,2516]天(17130,380)空(17510,312)它(17822,351)像(18173,336)什(18509,370)么(18879,767)
[20917,2544]爱(20917,271)情(21188,279)就(21467,354)像(21821,344)什(22165,399)么(22564,897)
[24703,5854]几(24703,341)朵(25044,272)云(25316,304)在(25620,395)阴(26015,420)天(26435,577)忘(27012,433)了(27445,520)该(27965,415)往(28380,370)哪(28750,410)儿(29160,515)走(29675,882)
[32062,2301]思(32062,344)念(32406,295)和(32701,346)寂(33047,314)寞(33361,1002)
[34931,3186]被(34931,351)吹(35282,433)进(35715,447)了(36162,521)左(36683,351)耳(37034,1083)
[38557,1878]也(38557,232)许(38789,278)我(39067,368)记(39435,248)不(39683,257)住(39940,495)
[40668,3111]可(40668,216)是(40884,199)也(41083,240)忘(41323,248)不(41571,265)掉(41836,424)那(42260,340)时(42600,251)候(42851,928)
[44121,3054]那(44121,339)种(44460,232)秘(44692,299)密(44991,413)的(45404,455)快(45859,488)乐(46347,828)
[50566,2959]听(50566,240)阴(50806,255)天(51061,272)说(51333,288)什(51621,321)么(51942,1583)
[54279,2919]在(54279,287)昏(54566,266)暗(54832,229)中(55061,360)的(55421,377)我(55798,1400)
[58351,3633]想(58351,380)对(58731,324)着(59055,320)天(59375,481)讲(59856,473) (60329,0)说(60329,287)无(60616,304)论(60920,319)如(61239,401)何(61640,344)
[62223,2496]阴(62223,337)天(62560,304)快(62864,464)乐(63328,1391)
[65367,3048]叫(65367,306)阴(65673,279)天(65952,238)别(66190,314)闹(66504,335)了(66839,1576)
[68978,4167]想(68978,309)念(69287,296)你(69583,329)都(69912,361)那(70273,453)么(70726,322)久(71048,335)那(71383,331)么(71714,304)久(72018,333)了(72351,794)
[73239,3347]我(73239,305)一(73544,272)抬(73816,344)头(74160,824) (74984,0)就(74984,367)看(75351,355)见(75706,330)你(76036,550)
[76826,3204]那(76826,438)个(77264,361)酒(77625,398)窝(78023,2007)
[92964,2520]翻(92964,267)山(93231,269)越(93500,323)岭(93823,349)之(94172,359)后(94531,953)
[96633,2869]爱(96633,386)却(97019,265)神(97284,296)出(97580,345)鬼(97925,409)没(98334,1168)
[100462,5935]你(100462,280)像(100742,240)一(100982,310)首(101292,393)唱(101685,394)到(102079,380)沙(102459,508)哑(102967,629)偏(103596,434)爱(104030,467)的(104497,420)情(104917,521)歌(105438,959)
[107767,2471]旅(107767,322)途(108089,251)中(108340,368)坐(108708,335)一(109043,314)坐(109357,881)
[110766,2894]在(110766,288)秋(111054,351)千(111405,392)上(111797,520)的(112317,447)我(112764,896)
[114273,5064]原(114273,241)来(114514,232)我(114746,324)忽(115070,251)略(115321,319)的(115640,538)如(116178,258)今(116436,223)想(116659,261)纪(116920,304)念(117224,245)也(117469,427)没(117896,473)用(118369,968)
[119800,4313]那(119800,252)些(120052,252)时(120304,322)光(120626,408)的(121034,463)因(121497,431)果(121928,2185)
[124569,3081]听(124569,240)阴(124809,241)天(125050,247)说(125297,330)什(125627,289)么(125916,1734)
[128137,2879]在(128137,272)昏(128409,285)暗(128694,242)中(128936,417)的(129353,299)我(129652,1364)
[132128,3544]想(132128,337)对(132465,319)着(132784,369)天(133153,405)讲(133558,454) (134012,0)说(134012,370)无(134382,290)论(134672,329)如(135001,416)何(135417,255)
[135989,2556]阴(135989,363)天(136352,332)快(136684,391)乐(137075,1470)
[139297,2936]叫(139297,239)阴(139536,258)天(139794,256)别(140050,322)闹(140372,341)了(140713,1520)
[143024,3956]想(143024,248)念(143272,216)你(143488,290)都(143778,318)那(144096,427)么(144523,369)久(144892,337)那(145229,319)么(145548,320)久(145868,333)了(146201,779)
[147188,3224]我(147188,253)一(147441,250)抬(147691,311)头(148002,879) (148881,0)就(148881,329)看(149210,312)见(149522,328)你(149850,562)
[150737,2995]那(150737,360)个(151097,336)酒(151433,447)窝(151880,1852)
[155863,2689]过(155863,354)去(156217,416)穿(156633,403)过(157036,316)了(157352,273)现(157625,393)在(158018,534)
[158705,3846]绕(158705,232)过(158937,240)了(159177,280)未(159457,392)来(159849,547)缝(160396,307)在(160703,249)心(160952,345)海(161297,447)中(161744,807)
[163361,4575]带(163361,313)着(163674,359)你(164033,430)我(164463,249)旅(164712,338)行(165050,414)变(165464,411)成(165875,334)老(166209,347)头(166556,1380)
[170740,2602]孤(170740,311)单(171051,343)怕(171394,353)成(171747,279)了(172026,336)习(172362,395)惯(172757,585)
[173416,4115]所(173416,277)以(173693,221)我(173914,321)淡(174235,304)定(174539,295)走(174834,329)在(175163,536)人(175699,424)海(176123,296)中(176419,1112)
[178202,5208]偶(178202,259)尔(178461,357)想(178818,401)看(179219,264)云(179483,335)飞(179818,368)却(180186,453)没(180639,443)风(181082,2328)
[183749,2357]听(183749,229)阴(183978,209)天(184187,224)说(184411,272)什(184683,280)么(184963,1143)
[187415,2324]在(187415,236)昏(187651,226)暗(187877,233)中(188110,268)的(188378,289)我(188667,1072)
[191133,3638]想(191133,415)对(191548,295)着(191843,353)天(192196,390)讲(192586,491) (193077,0)说(193077,397)无(193474,328)论(193802,305)如(194107,394)何(194501,270)
[195082,3048]阴(195082,396)天(195478,349)快(195827,480)乐(196307,1823)
[198379,3040]叫(198379,257)阴(198636,236)天(198872,283)别(199155,319)闹(199474,320)了(199794,1625)
[201943,4279]想(201943,257)念(202200,302)你(202502,312)都(202814,321)那(203135,387)么(203522,347)久(203869,425)那(204294,340)么(204634,320)久(204954,404)了(205358,864)
[206377,8009]我(206377,229)一(206606,194)抬(206800,277)头(207077,829) (207906,0)就(207906,296)看(208202,271)见(208473,488)了(208961,913) (209874,0)当(209874,344)时(210218,415)的(210633,591)我(211224,3162)
)";
vector<Line> lines;

void parser(string qrc){
    for (size_t pos = 0;pos < qrc.length();){
        size_t start = qrc.find_first_of('\n',pos);
        if (start == std::string::npos)
            break;
        size_t end = qrc.find_first_of('\n',start + 1);
        if (end == std::string::npos)
            break;
        string line = qrc.substr(start + 1,end - start - 1);

        long lineStartTime,lineDuration;
        sscanf(line.c_str(),"[%ld,%ld]",&lineStartTime,&lineDuration);

        size_t lte = line.find_first_of(']');

        string wordsAndTime = line.substr(lte + 1);

        Line l;
        l.startTime = lineStartTime;
        l.duration = lineDuration;

        int startX = 0;

        for(size_t pos2 = 0;pos2 < wordsAndTime.length();){
            size_t s = wordsAndTime.find_first_of("(",pos2);
            size_t e = wordsAndTime.find_first_of(")",s);
            string word = wordsAndTime.substr(pos2,s - pos2);

            string td = wordsAndTime.substr(s,e - s);
            long wordStartTime,wordDuration;
            sscanf(td.c_str(),"(%ld,%ld)",&wordStartTime,&wordDuration);
            Word wd;
            wd.startTime = wordStartTime;
            wd.duration = wordDuration;
            wd.word = word;
            wd.startX = startX;
            startX += u8g2.getUTF8Width(word.c_str()) * 2 + 1;
            l.words.emplace_back(wd);

            pos2 = e + 1;
        }
        lines.emplace_back(l);
        pos = start + 1;
    }
}

void setupa() {
    Serial.begin(115200);
    u8g2.begin();
    u8g2.enableUTF8Print();
    u8g2.setFont(u8g2_font_wqy12_t_gb2312);

    parser(qrc);
}

Line getCurrentLine(long time) {
    Line currentLine = Line();
    for (const Line& line: lines) {
        if (line.startTime <= time) {
            currentLine = line;
        }
    }
    return currentLine;
}

Word getCurrentWord(const Line &line, long time) {
    Word currentWord = Word();
    for (const Word &word: line.words) {
        if (word.startTime <= time) {
            currentWord = word;
        }
    }
    return currentWord;
}

String title = "未播放";
float position = 1;
float songLength = 1;

int cur = 0;

long lastLine;
void loopa() {
    u_long thisFrame = millis();

    Line line = getCurrentLine(thisFrame);
    if(line.startTime != lastLine){
        lastLine = line.startTime;
        cur = 0;
    }
    Word curWord = getCurrentWord(line,thisFrame);

    u8g2.clearBuffer();
    u8g2.setFont(u8g2_font_wqy14_t_gb2312);
    u8g2.drawUTF8(0,u8g2.getMaxCharHeight(),title.c_str());
    u8g2.drawFrame(0,u8g2.getHeight() - 15,u8g2.getWidth(),15);
    u8g2.drawBox(0,u8g2.getHeight() - 15,u8g2.getDisplayWidth() * float (position / songLength),15);

    u8g2.setFont(u8g2_font_wqy12_t_gb2312);

    for(const Word& w : line.words){
        if (w.startTime <= thisFrame) {
            if(w.startX + cur + u8g2.getUTF8Width(w.word.c_str()) * 2 >= u8g2.getDisplayWidth()){
                cur -= w.startX + cur + u8g2.getUTF8Width(w.word.c_str()) * 2 - u8g2.getDisplayWidth();
            }
        }
        u8g2.drawUTF8X2(w.startX + cur,u8g2.getHeight() - 20,w.word.c_str());
    }
    u8g2.sendBuffer();
}*/
